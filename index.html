<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Road to Barcelona ¬∑ Freeland</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,700;1,600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Freeland */
  --fl-blue:#354FA2;
  --fl-blue-dk:#253a82;
  --fl-blue-lt:#EEF1FA;
  --fl-blue-mid:rgba(53,79,162,.1);
  --fl-orange:#FF9C00;
  --fl-orange-lt:#FFF4E0;
  --fl-orange-border:rgba(255,156,0,.3);
  /* Bar√ßa / Barcelona */
  --barca-red:#A50044;
  --barca-red-lt:rgba(165,0,68,.08);
  --barca-red-border:rgba(165,0,68,.22);
  --barca-blue:#004D98;
  --barca-gold:#EDBB00;
  --barca-gold-lt:#FFFBE8;
  /* Layout */
  --bg:#FAF7F2;
  --bg2:#F3EFE6;
  --surface:#FFFFFF;
  --surface2:#F7F4EE;
  --border:#E4DDD0;
  --border2:#D5CCBC;
  /* Text */
  --text:#1A1F3A;
  --muted:#7A7464;
  --muted2:#B0A898;
  /* Team colors - warm */
  --t1:#354FA2;--t2:#22A86B;--t3:#A50044;--t4:#FF9C00;--t5:#EDBB00;
  /* Status */
  --green:#1A9E62;--red:#D63F3F;
}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;line-height:1.55}

/* Warm sunny background */
body::before{
  content:'';position:fixed;inset:0;
  background:
    radial-gradient(ellipse 70% 50% at 85% 5%,rgba(255,156,0,.09) 0,transparent 55%),
    radial-gradient(ellipse 50% 60% at 10% 90%,rgba(165,0,68,.06) 0,transparent 55%),
    radial-gradient(ellipse 80% 40% at 50% 0%,rgba(237,187,0,.06) 0,transparent 50%);
  pointer-events:none;z-index:0
}

.wrap{position:relative;z-index:1;max-width:1040px;margin:0 auto;padding:0 24px 80px}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 0;border-bottom:2px solid var(--border);margin-bottom:0;
  flex-wrap:wrap;gap:12px
}
.nav-logo{
  display:flex;align-items:center;gap:10px;
  font-family:'Outfit',sans-serif;font-weight:800;font-size:18px;color:var(--fl-blue)
}
.nav-logo-mark{
  width:34px;height:34px;background:var(--fl-blue);border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;color:#fff;font-weight:900
}
.nav-logo .x{color:var(--muted);font-weight:400;margin:0 4px}
.nav-logo .barca{color:var(--barca-red)}
.nav-tabs{display:flex;gap:4px}
.tab-btn{
  background:none;border:none;color:var(--muted);font-family:'Outfit',sans-serif;
  font-size:14px;font-weight:500;padding:8px 18px;border-radius:8px;
  cursor:pointer;transition:all .2s
}
.tab-btn:hover{color:var(--text);background:var(--surface2)}
.tab-btn.active{
  color:var(--fl-blue);background:var(--fl-blue-lt);
  font-weight:700;border:1px solid rgba(53,79,162,.18)
}
.mode-chip{
  display:flex;align-items:center;gap:7px;padding:7px 15px;border-radius:20px;
  font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;
  border:1.5px solid;cursor:pointer;transition:all .2s
}
.mode-chip.pub{color:var(--muted);border-color:var(--border2);background:var(--surface)}
.mode-chip.pub:hover{border-color:var(--fl-blue);color:var(--fl-blue)}
.mode-chip.adm{color:var(--fl-blue);border-color:var(--fl-blue);background:var(--fl-blue-lt);font-weight:800}
.chip-dot{width:6px;height:6px;border-radius:50%}
.mode-chip.pub .chip-dot{background:var(--muted)}
.mode-chip.adm .chip-dot{background:var(--fl-orange);box-shadow:0 0 5px var(--fl-orange)}

/* ‚îÄ‚îÄ HERO HEADER ‚îÄ‚îÄ */
.hero{
  padding:52px 0 44px;text-align:center;position:relative
}
.hero-eyebrow{
  display:inline-flex;align-items:center;gap:8px;
  background:var(--fl-orange-lt);border:1px solid var(--fl-orange-border);
  border-radius:20px;padding:5px 14px;
  font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--fl-orange);margin-bottom:20px
}
.hero h1{
  font-family:'Playfair Display',serif;
  font-size:clamp(40px,6vw,72px);font-weight:700;line-height:1;
  color:var(--text);margin-bottom:8px
}
.hero h1 em{
  font-style:italic;
  background:linear-gradient(135deg,var(--barca-red),var(--fl-orange));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
}
.hero-sub{font-size:16px;color:var(--muted);max-width:520px;margin:12px auto 0}

/* Bar√ßa stripe accent */
.barca-stripe{
  height:4px;width:100px;margin:18px auto 0;border-radius:2px;
  background:linear-gradient(90deg,var(--barca-blue) 33%,var(--barca-red) 33%,var(--barca-red) 66%,var(--barca-gold) 66%)
}

/* ‚îÄ‚îÄ UPDATE BANNER ‚îÄ‚îÄ */
.upd-banner{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:16px 22px;margin-bottom:28px;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;
  box-shadow:0 2px 12px rgba(53,79,162,.06)
}
.upd-left{display:flex;align-items:center;gap:14px}
.upd-icon{
  width:40px;height:40px;background:var(--fl-blue-lt);border:1.5px solid rgba(53,79,162,.2);
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0
}
.upd-label{font-size:13px;color:var(--text);font-weight:600}
.upd-next{font-size:12px;color:var(--muted);margin-top:2px}
.upd-next b{color:var(--fl-blue)}
.upd-countdown{
  font-family:'Outfit',sans-serif;font-size:22px;font-weight:800;
  color:var(--barca-red);letter-spacing:.5px
}
.upd-pending{font-size:11px;color:var(--muted);margin-top:2px;font-weight:600}

/* ‚îÄ‚îÄ META ‚îÄ‚îÄ */
.meta-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:32px}
.meta-card{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:20px 16px;text-align:center;
  box-shadow:0 2px 8px rgba(26,31,58,.04)
}
.meta-v{
  font-family:'Playfair Display',serif;font-size:32px;font-weight:700;
  color:var(--fl-blue);display:block;line-height:1;margin-bottom:4px
}
.meta-l{font-size:11px;color:var(--muted);font-weight:600;letter-spacing:.3px;text-transform:uppercase}

/* ‚îÄ‚îÄ SECTION HEADS ‚îÄ‚îÄ */
.sec-head{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.sec-head h2{
  font-family:'Outfit',sans-serif;font-size:14px;font-weight:800;
  color:var(--text);letter-spacing:.5px;text-transform:uppercase;white-space:nowrap
}
.sec-line{flex:1;height:1.5px;background:var(--border)}

/* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ */
.lb{display:flex;flex-direction:column;gap:10px;margin-bottom:36px}
.tc{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:18px 22px;display:grid;grid-template-columns:50px 1fr auto;
  align-items:center;gap:16px;position:relative;overflow:hidden;
  transition:border-color .2s,transform .2s,box-shadow .2s;
  box-shadow:0 2px 8px rgba(26,31,58,.04)
}
.tc:hover{border-color:rgba(53,79,162,.3);transform:translateX(3px);box-shadow:0 4px 20px rgba(53,79,162,.1)}
.tc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--tc);border-radius:4px 0 0 4px}
.tc.top2{background:linear-gradient(135deg,#fffdf8 0%,#fff8ec 100%);border-color:rgba(255,156,0,.35)}
.tc.top2 .bcn-tag{
  position:absolute;right:14px;top:8px;
  font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;
  color:var(--barca-red);opacity:.85
}
.rank-n{
  font-family:'Playfair Display',serif;font-size:28px;font-weight:700;
  color:var(--muted2);text-align:center;font-style:italic
}
.rank-n.r1{color:var(--barca-gold)}
.rank-n.r2{color:var(--muted)}
.t-name{font-size:15px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;margin-bottom:5px}
.t-dot{width:9px;height:9px;border-radius:50%;background:var(--tc);flex-shrink:0}
.t-members{font-size:11px;color:var(--muted);font-weight:500}
.t-bar{height:3px;background:var(--bg2);border-radius:2px;margin-top:9px;overflow:hidden}
.t-fill{height:100%;background:var(--tc);border-radius:2px;opacity:.75;transition:width .8s cubic-bezier(.25,.8,.25,1)}
.t-pts-v{
  font-family:'Playfair Display',serif;font-size:36px;font-weight:700;
  color:var(--fl-blue);display:block;line-height:1
}
.t-pts-l{font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.8px;text-transform:uppercase}
.t-pts-p{font-size:10px;color:var(--fl-orange);font-weight:700;margin-top:3px;display:block}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none}.page.active{display:block}

/* ‚îÄ‚îÄ MISSION FORM ‚îÄ‚îÄ */
.mission-card{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:30px;margin-bottom:12px;box-shadow:0 2px 12px rgba(26,31,58,.05)
}
.mission-card h3{
  font-family:'Playfair Display',serif;font-size:22px;font-weight:700;
  color:var(--text);margin-bottom:6px
}
.mission-card .mc-sub{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.6}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(165px,1fr));gap:14px;margin-bottom:16px}
label{
  display:block;font-size:11px;font-weight:700;letter-spacing:1px;
  color:var(--muted);text-transform:uppercase;margin-bottom:7px
}
input[type=password],input[type=text],select{
  width:100%;background:var(--bg);border:1.5px solid var(--border);
  border-radius:8px;color:var(--text);font-family:'Outfit',sans-serif;
  font-size:14px;padding:11px 14px;outline:none;transition:border-color .2s
}
input:focus,select:focus{border-color:var(--fl-blue)}
option{background:#fff}
.chk-group{display:flex;flex-direction:column;gap:9px;padding-top:2px}
.chk-item{display:flex;align-items:center;gap:8px;cursor:pointer}
.chk-item input[type=checkbox]{width:16px;height:16px;accent-color:var(--fl-blue);padding:0;flex-shrink:0;margin:0}
.chk-item span{font-size:13px;color:var(--text)}
.chk-badge{
  font-size:10px;font-weight:800;color:var(--fl-blue);
  background:var(--fl-blue-lt);border:1px solid rgba(53,79,162,.2);
  padding:2px 7px;border-radius:5px;margin-left:auto
}
.preview-box{
  background:var(--fl-blue-lt);border:1.5px solid rgba(53,79,162,.2);
  border-radius:8px;padding:11px 16px;font-size:13px;color:var(--fl-blue);
  font-weight:700;margin-bottom:14px
}
.info-box{
  background:var(--fl-orange-lt);border:1.5px solid var(--fl-orange-border);
  border-radius:8px;padding:10px 14px;font-size:12px;color:var(--text);
  margin-bottom:18px;line-height:1.5
}
.info-box b{color:var(--fl-orange)}

/* My pending counter */
.my-pending{
  background:linear-gradient(135deg,var(--fl-orange-lt),#fff9f0);
  border:1.5px solid var(--fl-orange-border);border-radius:12px;
  padding:16px 20px;margin-bottom:14px;
  display:flex;align-items:center;justify-content:space-between;gap:12px
}
.mp-left{display:flex;align-items:center;gap:12px}
.mp-icon{font-size:22px}
.mp-title{font-size:14px;font-weight:700;color:var(--text)}
.mp-sub{font-size:12px;color:var(--muted)}
.mp-count{font-family:'Playfair Display',serif;font-size:32px;font-weight:700;color:var(--fl-orange)}
.mp-pts{font-size:11px;color:var(--muted);text-align:right;font-weight:600}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  background:var(--fl-blue);color:#fff;border:none;border-radius:9px;
  padding:12px 26px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;
  cursor:pointer;transition:all .2s
}
.btn:hover{background:var(--fl-blue-dk);transform:translateY(-1px);box-shadow:0 4px 14px rgba(53,79,162,.3)}
.btn:active{transform:translateY(0)}
.btn-orange{background:var(--fl-orange);color:#fff}
.btn-orange:hover{background:#e68900;box-shadow:0 4px 14px rgba(255,156,0,.3)}
.btn-ghost{background:var(--surface);color:var(--muted);border:1.5px solid var(--border);font-weight:600}
.btn-ghost:hover{border-color:var(--fl-blue);color:var(--fl-blue)}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#15875a}
.btn-red{background:rgba(214,63,63,.08);color:var(--red);border:1.5px solid rgba(214,63,63,.2);font-size:12px;padding:9px 18px}
.btn-red:hover{background:rgba(214,63,63,.14)}
.btn-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn-sm{padding:9px 18px;font-size:12px;border-radius:7px}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-wrap{max-width:440px;margin:32px auto 0}
.login-card{
  background:var(--surface);border:1.5px solid var(--border);border-radius:14px;
  padding:36px;box-shadow:0 4px 20px rgba(26,31,58,.08)
}
.login-card h3{font-family:'Playfair Display',serif;font-size:24px;color:var(--text);margin-bottom:6px}
.login-card p{font-size:13px;color:var(--muted);margin-bottom:24px}
.err-msg{color:var(--red);font-size:12px;margin-top:8px;font-weight:700}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
.admin-card{
  background:var(--surface);border:1.5px solid var(--border);border-radius:14px;
  padding:28px;margin-bottom:20px;box-shadow:0 2px 12px rgba(26,31,58,.05)
}
.admin-card h3{font-family:'Playfair Display',serif;font-size:22px;color:var(--text);margin-bottom:20px}
.force-banner{
  background:linear-gradient(135deg,rgba(26,158,98,.08),rgba(26,158,98,.04));
  border:1.5px solid rgba(26,158,98,.25);border-radius:12px;
  padding:14px 20px;margin-bottom:20px;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px
}
.fb-text{font-size:13px;color:var(--green);font-weight:700}
.log-scroll{
  max-height:420px;overflow-y:auto;display:flex;flex-direction:column;
  gap:8px;padding-right:4px;margin-bottom:20px
}
.log-scroll::-webkit-scrollbar{width:4px}
.log-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.li{
  background:var(--bg);border:1.5px solid var(--border);border-radius:9px;
  padding:11px 14px;display:flex;align-items:center;gap:10px;font-size:12px
}
.li.pending{border-left:3px solid var(--fl-orange)}
.li.published{border-left:3px solid var(--green)}
.li-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.li-date{font-size:10px;color:var(--muted);min-width:76px;font-weight:700}
.li-st{
  font-size:9px;font-weight:800;letter-spacing:1px;padding:3px 8px;
  border-radius:5px;text-transform:uppercase;flex-shrink:0;white-space:nowrap
}
.li-st.pub{background:rgba(26,158,98,.1);color:var(--green)}
.li-st.pend{background:var(--fl-orange-lt);color:var(--fl-orange)}
.li-desc{flex:1;color:var(--text)}
.li-pts{
  font-family:'Playfair Display',serif;font-size:18px;font-weight:700;
  color:var(--fl-blue);min-width:50px;text-align:right
}
.li-del{
  color:var(--red);background:none;border:none;cursor:pointer;
  font-size:14px;opacity:.3;transition:opacity .2s;padding:3px 6px
}
.li-del:hover{opacity:1}
.empty{text-align:center;padding:30px;color:var(--muted);font-size:13px;font-weight:600}
.admin-settings{
  background:var(--surface);border:1.5px solid var(--border);border-radius:14px;
  padding:24px;margin-bottom:24px
}
.admin-settings h3{font-family:'Playfair Display',serif;font-size:18px;color:var(--text);margin-bottom:16px}
.settings-info{font-size:12px;color:var(--muted);margin-top:10px}
.settings-info span{color:var(--fl-blue);font-weight:700}
.settings-info a{color:var(--muted);text-decoration:underline;cursor:pointer}
.settings-info a:hover{color:var(--fl-blue)}

/* ‚îÄ‚îÄ RULES PAGE ‚îÄ‚îÄ */
.rules-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.rule-card{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:24px;box-shadow:0 2px 8px rgba(26,31,58,.04)
}
.rule-card.full{grid-column:1/-1}
.rule-card h3{
  font-size:12px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--fl-blue);margin-bottom:16px;display:flex;align-items:center;gap:8px
}
.rt{width:100%;border-collapse:collapse}
.rt tr{border-bottom:1px solid var(--border)}
.rt tr:last-child{border:none}
.rt td{padding:9px 4px;font-size:13px;color:var(--text)}
.rt td:last-child{text-align:right;font-weight:800;color:var(--fl-blue);font-size:13px}
.teams-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:12px;margin-bottom:24px}
.team-mini{
  background:var(--surface);border:1.5px solid var(--border);border-radius:12px;
  padding:18px;border-top:4px solid var(--tc);
  box-shadow:0 2px 8px rgba(26,31,58,.04)
}
.team-mini-name{font-size:13px;font-weight:800;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.team-mini-member{
  display:flex;align-items:center;justify-content:space-between;
  font-size:12px;color:var(--text);padding:5px 0;border-bottom:1px solid var(--border)
}
.team-mini-member:last-child{border:none}
.hat-badge{
  font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;
  background:var(--fl-blue-lt);color:var(--fl-blue);flex-shrink:0
}
.tl-item{display:flex;gap:16px;padding-bottom:22px}
.tl-item:last-child{padding-bottom:0}
.tl-left{display:flex;flex-direction:column;align-items:center;min-width:38px}
.tl-dot{
  width:34px;height:34px;border-radius:50%;background:var(--fl-blue-lt);
  border:2px solid rgba(53,79,162,.25);
  display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0
}
.tl-line{flex:1;width:2px;background:var(--border);margin-top:4px}
.tl-item:last-child .tl-line{display:none}
.tl-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px}
.tl-desc{font-size:12px;color:var(--muted)}
.reward-card{
  border-radius:14px;padding:32px;margin-bottom:40px;
  background:linear-gradient(135deg,var(--barca-blue) 0%,#003070 50%,var(--barca-red) 100%);
  display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:center;
  box-shadow:0 8px 32px rgba(0,77,152,.3)
}
.reward-left h3{
  font-family:'Playfair Display',serif;font-size:28px;font-weight:700;
  color:#fff;margin-bottom:8px
}
.reward-left p{font-size:13px;color:rgba(255,255,255,.75)}
.reward-left .pts-badge{
  display:inline-block;margin-top:10px;
  background:var(--barca-gold);color:var(--text);
  font-size:12px;font-weight:800;padding:5px 14px;border-radius:20px;letter-spacing:.5px
}
.reward-badges{display:flex;flex-direction:column;gap:8px}
.r-badge{
  background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
  backdrop-filter:blur(4px);border-radius:9px;
  padding:10px 14px;display:flex;align-items:center;gap:10px;
  font-size:13px;font-weight:500;color:#fff
}

/* ‚îÄ‚îÄ FLASH ‚îÄ‚îÄ */
.flash{
  position:fixed;bottom:24px;right:24px;
  padding:12px 20px;border-radius:10px;font-size:13px;font-weight:700;
  opacity:0;transform:translateY(8px);transition:all .3s;
  pointer-events:none;z-index:999;
}
.flash.show{opacity:1;transform:translateY(0)}
.flash.ok{background:var(--green);color:#fff;box-shadow:0 4px 16px rgba(26,158,98,.35)}
.flash.ef{background:var(--red);color:#fff;box-shadow:0 4px 16px rgba(214,63,63,.35)}
.flash.inf{background:var(--fl-blue);color:#fff;box-shadow:0 4px 16px rgba(53,79,162,.35)}

hr{border:none;border-top:1.5px solid var(--border);margin:32px 0}

@media(max-width:640px){
  .meta-bar{grid-template-columns:1fr 1fr}
  .rules-grid{grid-template-columns:1fr}
  .reward-card{grid-template-columns:1fr}
  .form-grid{grid-template-columns:1fr}
  .tc{grid-template-columns:36px 1fr auto;gap:10px;padding:14px 16px}
  .teams-grid{grid-template-columns:1fr 1fr}
  .nav-logo .x,.nav-logo .barca{display:none}
}
</style>
</head>
<body>
<div class="wrap">
<nav>
  <div class="nav-logo">
    <div class="nav-logo-mark">F</div>
    freeland <span class="x">√ó</span><span class="barca">Barcelona</span>
  </div>
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showPage('dashboard',this)">üèÜ Classement</button>
    <button class="tab-btn" onclick="showPage('rules',this)">üìã R√®gles</button>
  </div>
  <div class="mode-chip pub" id="mode-chip" onclick="toggleAdminLogin()">
    <div class="chip-dot"></div>
    <span id="mode-label">Vue publique</span>
  </div>
</nav>

<div id="page-dashboard" class="page active">
  <div class="hero">
    <div class="hero-eyebrow">‚úàÔ∏è Challenge Commercial ¬∑ 1 mars ‚Üí 31 mai 2026</div>
    <h1>Road to <em>Barcelona</em></h1>
    <p class="hero-sub">5 √©quipes ¬∑ 3 mois ¬∑ Les 2 premi√®res partent √† Barcelone</p>
    <div class="barca-stripe"></div>
  </div>

  <div class="upd-banner">
    <div class="upd-left">
      <div class="upd-icon">‚è±</div>
      <div>
        <div class="upd-label">Prochaine mise √† jour du classement</div>
        <div class="upd-next">Automatique ¬∑ <b id="next-label">‚Äî</b></div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="upd-countdown" id="countdown">‚Äî</div>
      <div class="upd-pending" id="pending-hint" style="display:none"></div>
    </div>
  </div>

  <div class="meta-bar">
    <div class="meta-card"><span class="meta-v" id="days-left">‚Äî</span><span class="meta-l">Jours restants</span></div>
    <div class="meta-card"><span class="meta-v" id="total-m">0</span><span class="meta-l">Missions publi√©es</span></div>
    <div class="meta-card"><span class="meta-v" id="total-p">0</span><span class="meta-l">Points distribu√©s</span></div>
    <div class="meta-card"><span class="meta-v" id="leader-n">‚Äî</span><span class="meta-l">Leader actuel</span></div>
  </div>

  <div class="sec-head"><h2>Classement officiel</h2><div class="sec-line"></div></div>
  <div class="lb" id="leaderboard"></div>

  <div class="sec-head" style="margin-top:40px"><h2>D√©clarer une mission</h2><div class="sec-line"></div></div>

  <div class="my-pending" id="my-pending" style="display:none">
    <div class="mp-left">
      <div class="mp-icon">‚è≥</div>
      <div>
        <div class="mp-title">Mes missions en attente</div>
        <div class="mp-sub">Publi√©es √† la prochaine mise √† jour du classement</div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="mp-count" id="my-count">0</div>
      <div class="mp-pts" id="my-pts">‚Äî pts en attente</div>
    </div>
  </div>

  <div class="mission-card">
    <h3>Nouvelle mission</h3>
    <p class="mc-sub">D√©clare une mission sign√©e pour faire gagner des points √† ton √©quipe. Les points seront publi√©s lors de la prochaine mise √† jour (toutes les 48h √† 09h30).</p>
    <div class="form-grid">
      <div>
        <label>√âquipe</label>
        <select id="sel-team" onchange="onTeamChange()">
          <option value="">‚Äî Choisir ‚Äî</option>
          <option value="0">üîµ √âquipe 1</option>
          <option value="1">üü¢ √âquipe 2</option>
          <option value="2">üü£ √âquipe 3</option>
          <option value="3">üü† √âquipe 4</option>
          <option value="4">üü° √âquipe 5</option>
        </select>
      </div>
      <div>
        <label>Commercial</label>
        <select id="sel-member"><option value="">‚Äî √âquipe d'abord ‚Äî</option></select>
      </div>
      <div>
        <label>Marge journali√®re</label>
        <select id="sel-marge" onchange="updPrev()">
          <option value="0">Moins de 50 ‚Ç¨ ‚Äî 0 pt</option>
          <option value="25">50 ‚Äì 79 ‚Ç¨ ‚Äî 25 pts</option>
          <option value="50">80 ‚Äì 99 ‚Ç¨ ‚Äî 50 pts</option>
          <option value="100">‚â• 100 ‚Ç¨ ‚Äî 100 pts</option>
        </select>
      </div>
      <div>
        <label>Synergie</label>
        <div class="chk-group">
          <label class="chk-item">
            <input type="checkbox" id="chk-portage" onchange="updPrev()">
            <span>Via portage</span><span class="chk-badge">+15</span>
          </label>
          <label class="chk-item">
            <input type="checkbox" id="chk-mq" onchange="updPrev()">
            <span>Issu d'un MQ</span><span class="chk-badge">+25</span>
          </label>
        </div>
      </div>
    </div>
    <div style="margin-bottom:14px">
      <label>Note (optionnel)</label>
      <input type="text" id="inp-note" placeholder="Nom client, contexte de la mission‚Ä¶">
    </div>
    <div class="preview-box" id="preview">Total mission : 0 pt ¬∑ sera publi√© √† la prochaine mise √† jour</div>
    <div class="info-box">‚ÑπÔ∏è Chaque mission est v√©rifi√©e avant publication. <b>L'historique global reste confidentiel</b> ‚Äî seul le classement est visible de tous.</div>
    <button class="btn btn-orange" onclick="addEntry()">+ D√©clarer ma mission</button>
  </div>

  <div id="login-box" style="display:none">
    <div class="login-wrap">
      <div class="login-card">
        <h3>Espace administrateur</h3>
        <p>Acc√®s r√©serv√© au gestionnaire. Historique complet, publication et suppression des missions.</p>
        <div style="margin-bottom:16px">
          <label>Mot de passe</label>
          <input type="password" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <div class="btn-row">
          <button class="btn" onclick="doLogin()">Connexion</button>
          <button class="btn btn-ghost" onclick="hideLogin()">Annuler</button>
        </div>
        <div class="err-msg" id="login-err" style="display:none">Mot de passe incorrect.</div>
      </div>
    </div>
  </div>

  <div id="admin-area" style="display:none;margin-top:12px">
    <div class="force-banner" id="force-banner" style="display:none">
      <div class="fb-text">‚ö° <span id="ready-count">0</span> mission(s) en attente de publication</div>
      <button class="btn btn-green btn-sm" onclick="forcePublish()">Publier maintenant</button>
    </div>
    <div class="admin-card">
      <h3>Historique complet</h3>
      <div class="log-scroll" id="log-list"><div class="empty">Aucune mission enregistr√©e</div></div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Se d√©connecter</button>
    </div>
    <div class="admin-settings">
      <h3>Administration</h3>
      <div class="btn-row">
        <button class="btn btn-red" onclick="exportData()">Exporter JSON</button>
        <button class="btn btn-red" onclick="resetAll()">R√©initialiser le challenge</button>
      </div>
      <div class="settings-info" style="margin-top:12px">
        Mot de passe : <span id="pwd-show"></span> ¬∑ <a onclick="changePwd()">Modifier</a>
      </div>
    </div>
  </div>
</div>

<div id="page-rules" class="page">
  <div class="hero">
    <div class="hero-eyebrow">üìã Road to Barcelona ¬∑ 2026</div>
    <h1>R√®gles du <em>Challenge</em></h1>
    <p class="hero-sub">Tout ce qu'il faut savoir pour d√©crocher son billet pour Barcelone.</p>
    <div class="barca-stripe"></div>
  </div>
  <p style="text-align:center;color:var(--muted);margin-bottom:40px">Consulte les r√®gles compl√®tes, le bar√®me de points et la composition des √©quipes.</p>
</div>

</div>
<div class="flash" id="flash"></div>

<script>
// CONFIG SUPABASE
const SUPABASE_URL='https://mpvuzooenrjqshmexkpi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wdnV6b29lbnJqcXNobWV4a3BpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTIxNDAsImV4cCI6MjA4Njk2ODE0MH0.gsiCbpyTBDtneThb4m-KaF49ShjhOtt4wxEog3Ue6XM';
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// CONFIG CHALLENGE
const START_DATE=new Date("2026-03-01T00:00:00");
const END_DATE=new Date("2026-05-31T23:59:59");
const DEFAULT_PWD="OLchampion2026";
const BASE_SLOT=new Date("2026-03-01T08:30:00Z");
const SLOT_MS=48*3600000;

const TEAMS=[
  {name:"√âquipe 1",color:"#354FA2",emoji:"üîµ",members:[{n:"JUS",h:1},{n:"ABD",h:2},{n:"AMZ",h:2},{n:"TSO",h:4}]},
  {name:"√âquipe 2",color:"#1A9E62",emoji:"üü¢",members:[{n:"AG",h:1},{n:"FBE",h:2},{n:"ADM",h:3},{n:"NOL",h:3},{n:"Marie",h:4}]},
  {name:"√âquipe 3",color:"#A50044",emoji:"üü£",members:[{n:"AT",h:1},{n:"YKA",h:2},{n:"WAT",h:3},{n:"LUL",h:4}]},
  {name:"√âquipe 4",color:"#FF9C00",emoji:"üü†",members:[{n:"MAV",h:1},{n:"MCN",h:2},{n:"ALH",h:3},{n:"Mariame",h:4}]},
  {name:"√âquipe 5",color:"#C4A000",emoji:"üü°",members:[{n:"KEL",h:1},{n:"MAG",h:1},{n:"TBO",h:3},{n:"SVD",h:4}]}
];

let published=[],pending=[],password=DEFAULT_PWD,lastPub=null,isAdmin=false;

// DATA FUNCTIONS
async function loadData(){
  try{
    console.log('üì° Connexion √† Supabase...');
    const {data:m,error:e}=await db.from('missions').select('*');
    if(e){
      console.error('‚ùå Erreur missions:',e.message,e);
      throw e;
    }
    console.log('‚úÖ Missions charg√©es:',m?m.length:0);
    if(m){published=m.filter(x=>x.status==='published');pending=m.filter(x=>x.status==='pending')}
    const {data:meta}=await db.from('metadata').select('*').eq('key','last_pub').single();
    if(meta)lastPub=parseInt(meta.value);
    const {data:cfg}=await db.from('admin_config').select('*').eq('key','password').single();
    if(cfg)password=cfg.value;
    console.log('‚úÖ Donn√©es charg√©es - Published:',published.length,'Pending:',pending.length);
    return true
  }catch(err){
    console.error('‚ùå Load error:',err.message||err);
    console.error('D√©tails complets:',err);
    return false
  }
}

async function saveMission(m){
  try{
    const {error}=await db.from('missions').insert([m]);
    if(error)throw error;
    await loadData();return true
  }catch(err){console.error('Save error:',err);flash('Erreur: '+err.message,'ef');return false}
}

async function removeMission(ts){
  try{
    const {error}=await db.from('missions').delete().eq('ts',ts);
    if(error)throw error;
    await loadData();return true
  }catch(err){console.error('Delete error:',err);return false}
}

async function publishAll(){
  try{
    const now=Date.now();
    const {error:e1}=await db.from('missions').update({status:'published',published_at:now}).eq('status','pending');
    if(e1)throw e1;
    const {error:e2}=await db.from('metadata').upsert({key:'last_pub',value:String(now)});
    if(e2)throw e2;
    await loadData();return true
  }catch(err){console.error('Publish error:',err);return false}
}

async function updatePassword(pwd){
  try{
    const {error}=await db.from('admin_config').upsert({key:'password',value:pwd});
    if(error)throw error;
    return true
  }catch(err){console.error('Pwd error:',err);return false}
}

// UI FUNCTIONS
function showPage(id,btn){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("page-"+id).classList.add("active");
  btn.classList.add("active");
}

function nextSlot(){
  const now=Date.now(),base=BASE_SLOT.getTime();
  if(now<base)return BASE_SLOT;
  return new Date(base+(Math.floor((now-base)/SLOT_MS)+1)*SLOT_MS);
}

function shouldAutoPublish(){
  if(!pending.length)return false;
  const now=Date.now(),base=BASE_SLOT.getTime(),lastMs=lastPub||0;
  const sNow=now<base?-1:Math.floor((now-base)/SLOT_MS);
  const sLast=lastMs<=base?-1:Math.floor((lastMs-base)/SLOT_MS);
  return sNow>sLast;
}

async function doPublish(msg=true){
  if(!pending.length){if(msg)flash("Aucune mission en attente","ef");return}
  const ok=await publishAll();
  if(ok){render();if(msg)flash("‚úì Points publi√©s !","ok")}
}

async function forcePublish(){
  if(!pending.length){flash("Aucune mission en attente","ef");return}
  if(!confirm("Publier "+pending.length+" mission(s) maintenant ?"))return;
  await doPublish(true);
}

const pad=n=>String(n).padStart(2,"0");
function fmtMs(ms){
  if(ms<=0)return "Publication imminente";
  const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);
  return pad(h)+"h "+pad(m)+"m "+pad(s)+"s";
}

async function tick(){
  if(shouldAutoPublish())await doPublish(false);
  const next=nextSlot(),ms=next-Date.now();
  const lbl=next.toLocaleString("fr-FR",{timeZone:"Europe/Paris",weekday:"short",day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
  document.getElementById("next-label").textContent=lbl;
  document.getElementById("countdown").textContent=fmtMs(ms);
  const ph=document.getElementById("pending-hint");
  if(isAdmin&&pending.length){ph.style.display="block";ph.textContent=pending.length+" mission(s) en attente"}
  else ph.style.display="none";
  const now2=Date.now(),dMs=END_DATE-now2,dStart=START_DATE-now2;
  let daysLabel=dStart>0?"Bient√¥t":dMs>0?Math.ceil(dMs/86400000):"Termin√©";
  document.getElementById("days-left").textContent=daysLabel;
}

function pubPts(){const a=TEAMS.map(()=>0);published.forEach(e=>{if(e.team!=null)a[e.team]+=e.pts});return a}
function pendPts(){const a=TEAMS.map(()=>0);pending.forEach(e=>{if(e.team!=null)a[e.team]+=e.pts});return a}

function render(){
  const pp=pubPts(),pe=pendPts(),mx=Math.max(...pp,1);
  const sorted=TEAMS.map((t,i)=>({...t,i,pts:pp[i],pend:pe[i]})).sort((a,b)=>b.pts-a.pts);
  document.getElementById("leaderboard").innerHTML=sorted.map((t,r)=>{
    const pct=(t.pts/mx*100).toFixed(1);
    const pTag=isAdmin&&t.pend>0?'<span class="t-pts-p">+'+t.pend+' en attente</span>':"";
    const bcnTag=r<2?'<span class="bcn-tag">‚úà BARCELONE</span>':"";
    return '<div class="tc '+(r<2?"top2":"")+'" style="--tc:'+t.color+'">'+bcnTag+'<div class="rank-n '+(r===0?"r1":r===1?"r2":"")+'">'+( r+1)+'</div><div><div class="t-name"><div class="t-dot"></div>'+t.emoji+' '+t.name+'<span style="font-size:11px;color:var(--muted);font-weight:500">'+t.members.length+' membres</span></div><div class="t-members">'+t.members.map(m=>m.n).join(" ¬∑ ")+'</div><div class="t-bar"><div class="t-fill" style="width:'+pct+'%"></div></div></div><div style="text-align:right"><span class="t-pts-v">'+t.pts+'</span><span class="t-pts-l"> pts</span>'+pTag+'</div></div>';
  }).join("");
  document.getElementById("total-m").textContent=published.length;
  document.getElementById("total-p").textContent=pubPts().reduce((a,b)=>a+b,0);
  document.getElementById("leader-n").textContent=sorted[0].pts>0?sorted[0].name.replace("√âquipe","√âq."):"‚Äî";
  const myP=getMyPending();
  const mpEl=document.getElementById("my-pending");
  if(myP.length>0){mpEl.style.display="flex";document.getElementById("my-count").textContent=myP.length;document.getElementById("my-pts").textContent=myP.reduce((a,e)=>a+e.pts,0)+" pts en attente"}else mpEl.style.display="none";
  renderAdminLog();
}

function renderAdminLog(){
  if(!isAdmin)return;
  const all=[...published.map(e=>({...e,status:"published"})),...pending.map(e=>({...e,status:"pending"}))].sort((a,b)=>b.ts-a.ts);
  const logEl=document.getElementById("log-list");
  if(!all.length){logEl.innerHTML='<div class="empty">Aucune mission enregistr√©e</div>';return}
  logEl.innerHTML=all.map(e=>{
    const t=TEAMS[e.team]||TEAMS[0];
    const syn=[e.portage?"Portage":"",e.mq?"MQ":""].filter(Boolean).join("+");
    const dt=new Date(e.ts).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
    return '<div class="li '+e.status+'"><div class="li-dot" style="background:'+t.color+'"></div><div class="li-date">'+dt+'</div><div class="li-st '+(e.status==="published"?"pub":"pend")+'">'+(e.status==="published"?"Publi√©":"En attente")+'</div><div class="li-desc">'+t.emoji+' '+t.name+' ¬∑ <strong>'+e.member+'</strong>'+(e.note?" ‚Äî "+e.note:"")+(syn?" ¬∑ "+syn:"")+'</div><div class="li-pts">+'+e.pts+'</div><button class="li-del" onclick="delEntry('+e.ts+')" title="Supprimer">‚úï</button></div>';
  }).join("");
  const fb=document.getElementById("force-banner");
  fb.style.display=pending.length?"flex":"none";
  document.getElementById("ready-count").textContent=pending.length;
}

function getMyPending(){
  const myTs=JSON.parse(sessionStorage.getItem("rtb_my_ts")||"[]");
  return pending.filter(e=>myTs.includes(e.ts));
}

function addMyTs(ts){
  const myTs=JSON.parse(sessionStorage.getItem("rtb_my_ts")||"[]");
  myTs.push(ts);sessionStorage.setItem("rtb_my_ts",JSON.stringify(myTs));
}

function toggleAdminLogin(){
  if(isAdmin){doLogout();return}
  const lb=document.getElementById("login-box");
  if(lb.style.display==="none"||!lb.style.display){showLogin()}else{hideLogin()}
}

function showLogin(){
  document.getElementById("login-box").style.display="block";
  setTimeout(()=>{document.getElementById("login-box").scrollIntoView({behavior:"smooth",block:"center"});document.getElementById("pwd-input").focus()},50);
}

function hideLogin(){
  document.getElementById("login-box").style.display="none";
  document.getElementById("login-err").style.display="none";
  document.getElementById("pwd-input").value="";
}

function doLogin(){
  if(document.getElementById("pwd-input").value===password){
    isAdmin=true;hideLogin();
    document.getElementById("admin-area").style.display="block";
    const mc=document.getElementById("mode-chip");
    mc.className="mode-chip adm";document.getElementById("mode-label").textContent="Admin";
    document.getElementById("pwd-show").textContent=password;
    render();tick();flash("Connect√© en mode admin","inf");
    setTimeout(()=>document.getElementById("admin-area").scrollIntoView({behavior:"smooth",block:"start"}),100);
  }else{
    document.getElementById("login-err").style.display="block";
    document.getElementById("pwd-input").value="";document.getElementById("pwd-input").focus();
  }
}

function doLogout(){
  isAdmin=false;document.getElementById("admin-area").style.display="none";
  document.getElementById("mode-chip").className="mode-chip pub";
  document.getElementById("mode-label").textContent="Vue publique";
  render();
}

async function changePwd(){
  const np=prompt("Nouveau mot de passe :");
  if(!np||!np.trim())return;
  password=np.trim();
  const ok=await updatePassword(password);
  if(ok){document.getElementById("pwd-show").textContent=password;flash("Mot de passe mis √† jour","ok")}
}

function onTeamChange(){
  const v=document.getElementById("sel-team").value;
  const sm=document.getElementById("sel-member");
  if(!v){sm.innerHTML='<option value="">‚Äî √âquipe d\'abord ‚Äî</option>';return}
  sm.innerHTML='<option value="">‚Äî Choisir ‚Äî</option>'+TEAMS[+v].members.map(m=>'<option>'+m.n+'</option>').join("");
  updPrev();
}

function calcPts(){
  return(parseInt(document.getElementById("sel-marge").value)||0)+(document.getElementById("chk-portage").checked?15:0)+(document.getElementById("chk-mq").checked?25:0);
}

function updPrev(){
  const p=calcPts();
  document.getElementById("preview").textContent="Total mission : "+p+" pt"+(p!==1?"s":"")+" ¬∑ sera publi√© √† la prochaine mise √† jour (48h / 09h30 Paris)";
}

async function addEntry(){
  const tv=document.getElementById("sel-team").value;
  const mem=document.getElementById("sel-member").value;
  if(!tv){flash("S√©lectionne une √©quipe","ef");return}
  if(!mem){flash("S√©lectionne un commercial","ef");return}
  const pts=calcPts(),ts=Date.now();
  const mission={team:+tv,member:mem,pts,portage:document.getElementById("chk-portage").checked,mq:document.getElementById("chk-mq").checked,note:document.getElementById("inp-note").value.trim(),ts,status:"pending"};
  const ok=await saveMission(mission);
  if(!ok)return;
  addMyTs(ts);
  document.getElementById("sel-team").value="";
  document.getElementById("sel-member").innerHTML='<option value="">‚Äî √âquipe d\'abord ‚Äî</option>';
  document.getElementById("sel-marge").value="0";
  document.getElementById("chk-portage").checked=false;
  document.getElementById("chk-mq").checked=false;
  document.getElementById("inp-note").value="";
  updPrev();render();flash("‚úì Mission d√©clar√©e ‚Äî +"+pts+" pts en attente","ok");
}

async function delEntry(ts){
  if(!confirm("Supprimer cette entr√©e ?"))return;
  const ok=await removeMission(ts);
  if(ok){render();flash("Entr√©e supprim√©e","inf")}
}

async function exportData(){
  const data={published,pending,lastPub,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:"rtb-backup.json"}).click();
}

async function resetAll(){
  if(!confirm("R√©initialiser TOUT le challenge ?"))return;
  if(!confirm("Confirmation finale ‚Äî action irr√©versible."))return;
  try{
    await db.from('missions').delete().neq('id','00000000-0000-0000-0000-000000000000');
    await db.from('metadata').upsert({key:'last_pub',value:'0'});
    await loadData();render();flash("Challenge r√©initialis√©","inf");
  }catch(err){console.error('Reset error:',err);flash("Erreur lors de la r√©initialisation","ef")}
}

function flash(msg,type){
  const el=document.getElementById("flash");
  el.textContent=msg;el.className="flash show "+(type||"inf");
  clearTimeout(flash._t);flash._t=setTimeout(()=>el.classList.remove("show"),3200);
}

// INIT
(async()=>{
  console.log('üöÄ Road to Barcelona - Initialisation...');
  console.log('üîó Supabase URL:',SUPABASE_URL);
  console.log('üîë Cl√© pr√©sente:',SUPABASE_KEY.substring(0,20)+'...');
  console.log('üì¶ SDK Supabase charg√©:',typeof window.supabase);
  
  const ok=await loadData();
  if(ok){
    console.log('‚úÖ Connexion Supabase OK - Initialisation termin√©e');
    render();tick();
    setInterval(tick,1000);
    setInterval(async()=>{await loadData();render()},10000);
  }else{
    console.error('‚ùå √âchec connexion Supabase');
    flash("Impossible de se connecter √† la base de donn√©es","ef");
  }
})();
</script>
</body>
</html>
